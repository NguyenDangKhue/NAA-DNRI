{% extends 'base.html' %}
{% block title %}Chi tiết công việc #{{ task.id }} · LabManage{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="fw-semibold text-primary-emphasis" style="font-size: 1.05rem;">
		<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#2ec4b6" class="me-1 mb-1" viewBox="0 0 16 16">
			<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
		</svg>
		Chi tiết công việc #{{ task.id }}
	</div>
	<div>
		<a href="{{ url_for('pages.task_assignment_my_tasks') }}" class="btn btn-outline-secondary">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
				<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
			</svg>
			Quay lại công việc của tôi
		</a>
	</div>
</div>

<div class="row">
	<!-- Thông tin công việc -->
	<div class="col-lg-8">
		<div class="card shadow-sm border-0 rounded-4 mb-4">
			<div class="card-header bg-primary text-white">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
					</svg>
					Thông tin công việc
				</h5>
			</div>
			<div class="card-body">
				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label fw-bold">Tiêu đề:</label>
						<p class="mb-0">{{ task.title }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Trạng thái:</label>
						<p class="mb-0">
							{% if task.status == 'pending' %}
								<span class="badge bg-warning">Chờ xử lý</span>
							{% elif task.status == 'in_progress' %}
								<span class="badge bg-info">Đang xử lý</span>
							{% elif task.status == 'completed' %}
								<span class="badge bg-success">Hoàn thành</span>
							{% elif task.status == 'cancelled' %}
								<span class="badge bg-secondary">Đã hủy</span>
							{% endif %}
						</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Độ ưu tiên:</label>
						<p class="mb-0">
							{% if task.priority == 'high' %}
								<span class="badge bg-danger">Cao</span>
							{% elif task.priority == 'medium' %}
								<span class="badge bg-warning">Trung bình</span>
							{% else %}
								<span class="badge bg-secondary">Thấp</span>
							{% endif %}
						</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Người hiện tại:</label>
						<p class="mb-0">{{ task.assigned_to }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Người giao ban đầu:</label>
						<p class="mb-0">{{ task.assigned_by }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Ngày tạo:</label>
						<p class="mb-0">{{ task.created_at[:10] }}</p>
					</div>
					{% if task.due_date %}
					<div class="col-md-6">
						<label class="form-label fw-bold">Hạn hoàn thành:</label>
						<p class="mb-0">{{ task.due_date }}</p>
					</div>
					{% endif %}
					<div class="col-12">
						<label class="form-label fw-bold">Mô tả:</label>
						<p class="mb-0">{{ task.description }}</p>
					</div>
					{% if task.category %}
					<div class="col-md-6">
						<label class="form-label fw-bold">Danh mục:</label>
						<p class="mb-0">{{ task.category }}</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
	<!-- Sơ đồ công việc -->
	<div class="col-lg-4">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-header bg-success text-white">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
					</svg>
					Sơ đồ công việc
				</h5>
			</div>
			<div class="card-body">
				<div class="timeline">
					{% for step in timeline %}
					<div class="timeline-item {% if step.is_current %}current{% endif %}">
						<div class="timeline-marker">
							{% if step.status == 'completed' %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
								</svg>
							{% elif step.status == 'in_progress' %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
								</svg>
							{% else %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
								</svg>
							{% endif %}
						</div>
						<div class="timeline-content">
							<h6 class="timeline-title">{{ step.stage }}</h6>
							<p class="timeline-text mb-1">
								<strong>Người thực hiện:</strong> {{ step.user }}
							</p>
							{% if step.handover_to %}
							<p class="timeline-text mb-1">
								<strong>Bàn giao cho:</strong> {{ step.handover_to }}
							</p>
							{% endif %}
							<p class="timeline-text mb-1">
								<strong>Thời gian:</strong> {{ step.date[:16] }}
							</p>
							{% if step.note %}
							<p class="timeline-text mb-0">
								<strong>Ghi chú:</strong> {{ step.note }}
							</p>
							{% endif %}
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Thao tác -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-header bg-light">
				<h5 class="mb-0">Thao tác</h5>
			</div>
			<div class="card-body">
				<div class="btn-group" role="group">
					{% if task.status == 'pending' %}
					<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
						<input type="hidden" name="status" value="in_progress">
						<button type="submit" class="btn btn-primary">Bắt đầu</button>
					</form>
					{% elif task.status == 'in_progress' %}
					<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
						<input type="hidden" name="status" value="completed">
						<button type="submit" class="btn btn-success">Hoàn thành</button>
					</form>
					{% elif task.status == 'completed' %}
					<a href="{{ url_for('pages.task_assignment_handover_form', task_id=task.id) }}" class="btn btn-info">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
							<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
						</svg>
						Bàn giao
					</a>
					{% endif %}
					
					<a href="{{ url_for('pages.task_assignment_edit_form', task_id=task.id) }}" class="btn btn-outline-secondary">
						Chỉnh sửa
					</a>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
.timeline {
	position: relative;
	padding-left: 30px;
}

.timeline-item {
	position: relative;
	margin-bottom: 20px;
	padding-bottom: 20px;
}

.timeline-item:not(:last-child)::after {
	content: '';
	position: absolute;
	left: -22px;
	top: 30px;
	width: 2px;
	height: calc(100% + 10px);
	background-color: #dee2e6;
}

.timeline-marker {
	position: absolute;
	left: -30px;
	top: 0;
	width: 20px;
	height: 20px;
	border-radius: 50%;
	background-color: #6c757d;
	color: white;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1;
}

.timeline-item.current .timeline-marker {
	background-color: #0d6efd;
}

.timeline-item:has(.timeline-marker svg[fill="currentColor"]) .timeline-marker {
	background-color: #198754;
}

.timeline-content {
	background-color: #f8f9fa;
	padding: 15px;
	border-radius: 8px;
	border-left: 3px solid #dee2e6;
}

.timeline-item.current .timeline-content {
	border-left-color: #0d6efd;
	background-color: #e7f3ff;
}

.timeline-title {
	font-size: 14px;
	font-weight: 600;
	margin-bottom: 8px;
	color: #495057;
}

.timeline-text {
	font-size: 12px;
	color: #6c757d;
	margin-bottom: 4px;
}
</style>

{% endblock %}

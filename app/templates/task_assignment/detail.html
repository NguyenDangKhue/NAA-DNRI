{% extends 'base.html' %}
{% block title %}Chi tiết công việc #{{ task.id }} · LabManage{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="fw-semibold text-primary-emphasis" style="font-size: 1.05rem;">
		<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#2ec4b6" class="me-1 mb-1" viewBox="0 0 16 16">
			<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
		</svg>
		Chi tiết công việc #{{ task.id }}
	</div>
	<div>
		<a href="{{ url_for('pages.task_assignment_my_tasks') }}" class="btn btn-outline-secondary">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
				<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
			</svg>
			Quay lại công việc của tôi
		</a>
	</div>
</div>

<div class="row">
		<!-- Upload File Section -->
		<div class="card mb-4">
			<div class="card-header bg-primary text-white">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8.5 6a.5.5 0 0 0-1 0v2.5H6a.5.5 0 0 0 0 1h2.5V10a.5.5 0 0 0 1 0V8.5H10a.5.5 0 0 0 0-1H8.5V6z"/>
						<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
					</svg>
					Upload File Kết Quả
				</h5>
			</div>
			<div class="card-body">
				<form method="POST" action="{{ url_for('pages.task_assignment_upload_file', task_id=task.id) }}" enctype="multipart/form-data">
					<div class="row g-3">
						<div class="col-md-4">
							<label class="form-label">Chọn công đoạn <span class="text-danger">*</span></label>
							<select name="stage_name" class="form-select" required>
								<option value="">-- Chọn công đoạn --</option>
								<option value="Nhận mẫu">Nhận mẫu</option>
								<option value="Đóng mẫu">Đóng mẫu</option>
								<option value="Chiếu mẫu">Chiếu mẫu</option>
								<option value="Xử lý số liệu">Xử lý số liệu</option>
								<option value="Kiểm tra và duyệt kết quả">Kiểm tra và duyệt kết quả</option>
								<option value="Lưu kết quả">Lưu kết quả</option>
							</select>
						</div>
						<div class="col-md-4">
							<label class="form-label">Chọn file <span class="text-danger">*</span></label>
							<input type="file" name="file" class="form-control" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.xls,.xlsx,.csv,.json,.zip,.rar" required>
							<div class="form-text">Hỗ trợ: Hình ảnh, PDF, Word, Excel, CSV, JSON, ZIP (tối đa 50MB)</div>
						</div>
						<div class="col-md-4">
							<label class="form-label">Mô tả file</label>
							<input type="text" name="description" class="form-control" placeholder="Mô tả ngắn về file...">
						</div>
					</div>
					<div class="mt-3">
						<button type="submit" class="btn btn-primary">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
								<path d="M8.5 6a.5.5 0 0 0-1 0v2.5H6a.5.5 0 0 0 0 1h2.5V10a.5.5 0 0 0 1 0V8.5H10a.5.5 0 0 0 0-1H8.5V6z"/>
							</svg>
							Upload File
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Files List Section -->
		{% if task.files %}
		<div class="card mb-4">
			<div class="card-header bg-light">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
					</svg>
					Files Đã Upload ({{ task.files|length }} files)
				</h5>
			</div>
			<div class="card-body">
				<div class="row">
					{% for file in task.files %}
					<div class="col-md-6 col-lg-4 mb-3">
						<div class="card h-100">
							<div class="card-body">
								<div class="d-flex align-items-start">
									<div class="me-3">
										{% if file.file_category == 'images' %}
										<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#28a745" viewBox="0 0 16 16">
											<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
											<path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.063L1.002 12V3a1 1 0 0 1 1-1h12z"/>
										</svg>
										{% elif file.file_category == 'documents' %}
										<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#dc3545" viewBox="0 0 16 16">
											<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
										</svg>
										{% elif file.file_category == 'data' %}
										<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#17a2b8" viewBox="0 0 16 16">
											<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
											<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.415.764-.42 1.6-1.185 1.184l-.292-.159a1.873 1.873 0 0 0-2.692 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
										</svg>
										{% else %}
										<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#6c757d" viewBox="0 0 16 16">
											<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
										</svg>
										{% endif %}
									</div>
									<div class="flex-grow-1">
										<h6 class="card-title mb-1">{{ file.original_filename }}</h6>
										<p class="card-text small text-muted mb-1">
											<strong>Công đoạn:</strong> {{ file.stage_name }}<br>
											<strong>Kích thước:</strong> {{ file.file_size_mb }} MB<br>
											<strong>Upload bởi:</strong> {{ file.uploaded_by }}<br>
											<strong>Thời gian:</strong> {{ file.uploaded_at[:16] }}
										</p>
										{% if file.description %}
										<p class="card-text small">{{ file.description }}</p>
										{% endif %}
									</div>
								</div>
							</div>
							<div class="card-footer bg-transparent">
								<div class="btn-group w-100" role="group">
									<a href="{{ url_for('pages.task_assignment_download_file', task_id=task.id, file_id=file.id) }}" class="btn btn-outline-primary btn-sm">
										<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
											<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
											<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
										</svg>
										Download
									</a>
									{% if task.assigned_to == session.get('username') %}
									<form method="POST" action="{{ url_for('pages.task_assignment_delete_file', task_id=task.id, file_id=file.id) }}" class="d-inline">
										<button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Bạn có chắc chắn muốn xóa file này?')">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
												<path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
												<path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
											</svg>
											Xóa
										</button>
									</form>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
		{% endif %}
	<div class="col-lg-8">
		<div class="card shadow-sm border-0 rounded-4 mb-4">
			<div class="card-header bg-primary text-white">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
					</svg>
					Thông tin công việc
				</h5>
			</div>
			<div class="card-body">
				<div class="row g-3">
					<div class="col-md-6">
						<label class="form-label fw-bold">Tiêu đề:</label>
						<p class="mb-0">{{ task.title }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Trạng thái:</label>
						<p class="mb-0">
							{% if task.status == 'pending' %}
								<span class="badge bg-warning">Chờ xử lý</span>
							{% elif task.status == 'in_progress' %}
								<span class="badge bg-info">Đang xử lý</span>
							{% elif task.status == 'completed' %}
								<span class="badge bg-success">Hoàn thành</span>
							{% elif task.status == 'cancelled' %}
								<span class="badge bg-secondary">Đã hủy</span>
							{% endif %}
						</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Độ ưu tiên:</label>
						<p class="mb-0">
							{% if task.priority == 'high' %}
								<span class="badge bg-danger">Cao</span>
							{% elif task.priority == 'medium' %}
								<span class="badge bg-warning">Trung bình</span>
							{% else %}
								<span class="badge bg-secondary">Thấp</span>
							{% endif %}
						</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Người hiện tại:</label>
						<p class="mb-0">{{ task.assigned_to }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Người giao ban đầu:</label>
						<p class="mb-0">{{ task.assigned_by }}</p>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold">Ngày tạo:</label>
						<p class="mb-0">{{ task.created_at[:10] }}</p>
					</div>
					{% if task.due_date %}
					<div class="col-md-6">
						<label class="form-label fw-bold">Hạn hoàn thành:</label>
						<p class="mb-0">{{ task.due_date }}</p>
					</div>
					{% endif %}
					<div class="col-12">
						<label class="form-label fw-bold">Mô tả:</label>
						<p class="mb-0">{{ task.description }}</p>
					</div>
					{% if task.category %}
					<div class="col-md-6">
						<label class="form-label fw-bold">Danh mục:</label>
						<p class="mb-0">{{ task.category }}</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
	<!-- Sơ đồ công việc -->
	<div class="col-lg-4">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-header bg-success text-white">
				<h5 class="mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
					</svg>
					Sơ đồ công việc
				</h5>
			</div>
			<div class="card-body">
				<div class="timeline">
					{% for step in timeline %}
					<div class="timeline-item {% if step.is_current %}current{% endif %}">
						<div class="timeline-marker">
							{% if step.status == 'completed' %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
								</svg>
							{% elif step.status == 'in_progress' %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
								</svg>
							{% else %}
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
								</svg>
							{% endif %}
						</div>
						<div class="timeline-content">
							<h6 class="timeline-title">{{ step.stage }}</h6>
							<p class="timeline-text mb-1">
								<strong>Người thực hiện:</strong> {{ step.user }}
							</p>
							{% if step.handover_to %}
							<p class="timeline-text mb-1">
								{% if step.user == step.handover_to %}
									<strong>Tiếp tục đảm nhận:</strong> <span class="text-primary">{{ step.handover_to }}</span>
								{% else %}
									<strong>Bàn giao cho:</strong> {{ step.handover_to }}
								{% endif %}
							</p>
							{% endif %}
							<p class="timeline-text mb-1">
								<strong>Thời gian:</strong> {{ step.date[:16] }}
							</p>
							{% if step.note %}
							<p class="timeline-text mb-0">
								<strong>Ghi chú:</strong> {{ step.note }}
							</p>
							{% endif %}
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Thao tác -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-header bg-light">
				<h5 class="mb-0">Thao tác</h5>
			</div>
			<div class="card-body">
				<div class="btn-group" role="group">
					{% if task.status == 'pending' %}
					<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
						<input type="hidden" name="status" value="in_progress">
						<button type="submit" class="btn btn-primary">Bắt đầu</button>
					</form>
					{% elif task.status == 'in_progress' %}
					<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
						<input type="hidden" name="status" value="completed">
						<button type="submit" class="btn btn-success">Hoàn thành</button>
					</form>
					{% elif task.status == 'completed' %}
					{% if can_handover %}
					<a href="{{ url_for('pages.task_assignment_handover_form', task_id=task.id) }}" class="btn btn-info">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
							<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
						</svg>
						Bàn giao
					</a>
					{% elif is_workflow_completed %}
					<span class="badge bg-success fs-6">Đã hoàn thành quy trình</span>
					{% else %}
					<span class="badge bg-info fs-6">Hoàn thành giai đoạn</span>
					{% endif %}
					{% endif %}
					
					<a href="{{ url_for('pages.task_assignment_edit_form', task_id=task.id) }}" class="btn btn-outline-secondary">
						Chỉnh sửa
					</a>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
.timeline {
	position: relative;
	padding-left: 30px;
}

.timeline-item {
	position: relative;
	margin-bottom: 20px;
	padding-bottom: 20px;
}

.timeline-item:not(:last-child)::after {
	content: '';
	position: absolute;
	left: -22px;
	top: 30px;
	width: 2px;
	height: calc(100% + 10px);
	background-color: #dee2e6;
}

.timeline-marker {
	position: absolute;
	left: -30px;
	top: 0;
	width: 20px;
	height: 20px;
	border-radius: 50%;
	background-color: #6c757d;
	color: white;
	display: flex;
	align-items: center;
	justify-content: center;
	z-index: 1;
}

.timeline-item.current .timeline-marker {
	background-color: #0d6efd;
}

.timeline-item:has(.timeline-marker svg[fill="currentColor"]) .timeline-marker {
	background-color: #198754;
}

.timeline-content {
	background-color: #f8f9fa;
	padding: 15px;
	border-radius: 8px;
	border-left: 3px solid #dee2e6;
}

.timeline-item.current .timeline-content {
	border-left-color: #0d6efd;
	background-color: #e7f3ff;
}

.timeline-title {
	font-size: 14px;
	font-weight: 600;
	margin-bottom: 8px;
	color: #495057;
}

.timeline-text {
	font-size: 12px;
	color: #6c757d;
	margin-bottom: 4px;
}
</style>

{% endblock %}

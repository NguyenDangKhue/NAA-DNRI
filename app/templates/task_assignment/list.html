{% extends 'base.html' %}
{% block title %}Danh sách công việc · LabManage{% endblock %}
{% block content %}

<style>
	/* Animation cho collapse */
	.collapse {
		transition: height 0.3s ease-in-out;
		overflow: hidden;
	}
	
	.collapse:not(.show) {
		height: 0;
	}
	
	.collapse.show {
		height: auto;
	}
	
	/* Style cho nút toggle của từng công việc */
	[id^="taskToggleIcon"] {
		font-weight: bold;
		font-size: 16px;
		transition: transform 0.2s ease;
	}
	
	.btn-outline-primary:hover [id^="taskToggleIcon"] {
		transform: scale(1.1);
	}
</style>

<script>
	// JavaScript để xử lý progress bar
	document.addEventListener('DOMContentLoaded', function() {
		const progressBars = document.querySelectorAll('.progress-bar[data-width]');
		progressBars.forEach(function(bar) {
			const width = bar.getAttribute('data-width');
			bar.style.width = width + '%';
		});
	});
	
	// JavaScript để toggle chi tiết giai đoạn cho từng công việc
	function toggleTaskDetails(taskId) {
		const container = document.getElementById('taskDetailsContainer' + taskId);
		const icon = document.getElementById('taskToggleIcon' + taskId);
		const text = document.getElementById('taskToggleText' + taskId);
		
		if (container.classList.contains('show')) {
			// Đóng
			container.classList.remove('show');
			icon.textContent = '+';
			text.textContent = 'Chi tiết';
		} else {
			// Mở
			container.classList.add('show');
			icon.textContent = '−';
			text.textContent = 'Thu gọn';
		}
	}
</script>

<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="fw-semibold text-primary-emphasis" style="font-size: 1.05rem;">
		<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#2ec4b6" class="me-1 mb-1" viewBox="0 0 16 16">
			<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
		</svg>
		Danh sách tất cả công việc
	</div>
	<div>
		<a href="{{ url_for('pages.task_assignment_create_form') }}" class="btn btn-primary me-2">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
				<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
			</svg>
			Tạo mới
		</a>
		<a href="{{ url_for('pages.task_assignment_export') }}" class="btn btn-success">
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
				<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
			</svg>
			Xuất Excel
		</a>
	</div>
</div>

<!-- Bộ lọc -->
<div class="card mb-4">
	<div class="card-body">
		<form method="GET" class="row g-3">
			<div class="col-md-3">
				<label class="form-label">Tìm kiếm</label>
				<input type="text" name="search" class="form-control" placeholder="Tìm kiếm..." value="{{ search_query }}">
			</div>
			<div class="col-md-2">
				<label class="form-label">Trạng thái</label>
				<select name="status" class="form-select">
					<option value="">Tất cả</option>
					<option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Chờ xử lý</option>
					<option value="in_progress" {% if selected_status == 'in_progress' %}selected{% endif %}>Đang xử lý</option>
					<option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Hoàn thành</option>
					<option value="cancelled" {% if selected_status == 'cancelled' %}selected{% endif %}>Đã hủy</option>
				</select>
			</div>
			<div class="col-md-2">
				<label class="form-label">Độ ưu tiên</label>
				<select name="priority" class="form-select">
					<option value="">Tất cả</option>
					<option value="high" {% if selected_priority == 'high' %}selected{% endif %}>Cao</option>
					<option value="medium" {% if selected_priority == 'medium' %}selected{% endif %}>Trung bình</option>
					<option value="low" {% if selected_priority == 'low' %}selected{% endif %}>Thấp</option>
				</select>
			</div>
			<div class="col-md-3">
				<label class="form-label">Người được giao</label>
				<select name="assigned_to" class="form-select">
					<option value="">Tất cả</option>
					{% for user in all_users %}
					<option value="{{ user.username }}" {% if selected_assigned_to == user.username %}selected{% endif %}>
						{{ user.username }}
					</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-2">
				<label class="form-label">&nbsp;</label>
				<div class="d-grid">
					<button type="submit" class="btn btn-primary">Lọc</button>
				</div>
			</div>
		</form>
	</div>
</div>

<!-- Danh sách công việc -->
<div class="card shadow-sm border-0 rounded-4">
	<div class="card-header bg-light">
		<h5 class="mb-0">
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
				<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
			</svg>
			Danh sách công việc ({{ total_count }} công việc)
		</h5>
	</div>
	<div class="card-body">
		{% if tasks %}
		{% for task in tasks %}
		<div class="card mb-3">
			<div class="card-header">
				<div class="d-flex align-items-center justify-content-between">
					<div>
						<h6 class="mb-0">
							<a href="{{ url_for('pages.task_assignment_detail', task_id=task.id) }}" class="text-decoration-none">
								Công việc #{{ task.id }}: {{ task.title }}
							</a>
						</h6>
						<div class="row mt-2">
							<div class="col-md-2">
								<small class="text-muted">Người giao: <strong>{{ task.assigned_by }}</strong></small>
							</div>
							<div class="col-md-2">
								<small class="text-muted">Người nhận: <strong>{{ task.assigned_to }}</strong></small>
							</div>
							<div class="col-md-2">
								<small class="text-muted">Độ ưu tiên: 
									{% if task.priority == 'high' %}
										<span class="badge bg-danger">Cao</span>
									{% elif task.priority == 'medium' %}
										<span class="badge bg-warning">Trung bình</span>
									{% else %}
										<span class="badge bg-secondary">Thấp</span>
									{% endif %}
								</small>
							</div>
							<div class="col-md-2">
								<small class="text-muted">Trạng thái: 
									{% if task.status == 'pending' %}
										<span class="badge bg-warning">Chờ xử lý</span>
									{% elif task.status == 'in_progress' %}
										<span class="badge bg-info">Đang xử lý</span>
									{% elif task.status == 'completed' %}
										<span class="badge bg-success">Hoàn thành</span>
									{% elif task.status == 'cancelled' %}
										<span class="badge bg-secondary">Đã hủy</span>
									{% endif %}
								</small>
							</div>
							<div class="col-md-2">
								<small class="text-muted">Giai đoạn: <span class="badge bg-primary">{{ task.stage_info.current_stage }}</span></small>
							</div>
							<div class="col-md-2">
								<small class="text-muted">Tiến độ: {{ task.stage_info.progress_percentage|round|int }}%</small>
							</div>
						</div>
						<div class="row mt-1">
							<div class="col-md-3">
								<small class="text-muted">Tạo: {{ task.created_at[:10] }}</small>
							</div>
							<div class="col-md-3">
								<small class="text-muted">
									Hạn: {% if task.due_date %}{{ task.due_date }}{% else %}-{% endif %}
								</small>
							</div>
							<div class="col-md-3">
								<small class="text-muted">
									Danh mục: {% if task.category %}{{ task.category }}{% else %}-{% endif %}
								</small>
							</div>
							<div class="col-md-3">
								<small class="text-muted">Cập nhật: {{ task.updated_at[:10] }}</small>
							</div>
						</div>
					</div>
					<div class="d-flex align-items-center gap-2">
						<button type="button" class="btn btn-outline-primary btn-sm" data-task-id="{{ task.id }}" onclick="toggleTaskDetails(this.dataset.taskId)">
							<span id="taskToggleIcon{{ task.id }}">+</span>
							<span id="taskToggleText{{ task.id }}">Chi tiết</span>
						</button>
						<div>
							<a href="{{ url_for('pages.task_assignment_edit_form', task_id=task.id) }}" class="btn btn-sm btn-outline-secondary">Chỉnh sửa</a>
							<button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ task.id }})">Xóa</button>
						</div>
					</div>
				</div>
			</div>
			<div id="taskDetailsContainer{{ task.id }}" class="collapse">
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<h6 class="text-primary">Giai đoạn đã trải qua:</h6>
							{% if task.stage_info.completed_stages %}
							<ul class="list-unstyled">
								{% for stage in task.stage_info.completed_stages %}
								<li class="mb-2">
									<span class="badge bg-success me-2">✓</span>
									<strong>{{ stage.stage }}</strong>
									<br>
									<small class="text-muted">
										Người thực hiện: {{ stage.user }}
										{% if stage.handover_to %}
											{% if stage.user == stage.handover_to %}
												→ <span class="text-primary">Tiếp tục đảm nhận</span>
											{% else %}
												→ Bàn giao cho: {{ stage.handover_to }}
											{% endif %}
										{% endif %}
										<br>
										Thời gian: {{ stage.date[:16] }}
										{% if stage.note %}<br>Ghi chú: {{ stage.note }}{% endif %}
									</small>
								</li>
								{% endfor %}
							</ul>
							{% else %}
							<p class="text-muted">Chưa có giai đoạn nào được hoàn thành</p>
							{% endif %}
						</div>
						<div class="col-md-6">
							<h6 class="text-info">Giai đoạn hiện tại:</h6>
							<div class="alert alert-info">
								<strong>{{ task.stage_info.current_stage }}</strong>
								<br>
								<small>
									Người thực hiện: {{ task.assigned_to }}<br>
									Trạng thái: 
									{% if task.status == 'pending' %}
										<span class="badge bg-warning">Chờ xử lý</span>
									{% elif task.status == 'in_progress' %}
										<span class="badge bg-info">Đang xử lý</span>
									{% elif task.status == 'completed' %}
										<span class="badge bg-success">Hoàn thành</span>
									{% endif %}
								</small>
							</div>
							<div class="progress mb-2">
								<div class="progress-bar" role="progressbar" 
										 data-width="{{ task.stage_info.progress_percentage }}" 
										 aria-valuenow="{{ task.stage_info.progress_percentage }}" 
										 aria-valuemin="0" aria-valuemax="100">
									{{ task.stage_info.progress_percentage|round|int }}%
								</div>
							</div>
							<small class="text-muted">
								Tiến độ: {{ task.stage_info.current_stage_index + 1 }}/{{ task.stage_info.total_stages + 1 }} giai đoạn
							</small>
						</div>
					</div>
					{% if task.description %}
					<div class="row mt-3">
						<div class="col-12">
							<h6 class="text-secondary">Mô tả:</h6>
							<p class="text-muted">{{ task.description }}</p>
						</div>
					</div>
					{% endif %}
					{% if task.note %}
					<div class="row mt-2">
						<div class="col-12">
							<h6 class="text-secondary">Ghi chú:</h6>
							<p class="text-muted">{{ task.note }}</p>
						</div>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
		{% endfor %}

		<!-- Phân trang -->
		{% if total_pages > 1 %}
		<nav aria-label="Phân trang">
			<ul class="pagination justify-content-center">
				{% if current_page > 1 %}
				<li class="page-item">
					<a class="page-link" href="?page={{ current_page - 1 }}&status={{ selected_status }}&priority={{ selected_priority }}&assigned_to={{ selected_assigned_to }}&search={{ search_query }}">Trước</a>
				</li>
				{% endif %}
				
				{% for page_num in range(1, total_pages + 1) %}
					{% if page_num == current_page %}
					<li class="page-item active">
						<span class="page-link">{{ page_num }}</span>
					</li>
					{% else %}
					<li class="page-item">
						<a class="page-link" href="?page={{ page_num }}&status={{ selected_status }}&priority={{ selected_priority }}&assigned_to={{ selected_assigned_to }}&search={{ search_query }}">{{ page_num }}</a>
					</li>
					{% endif %}
				{% endfor %}
				
				{% if current_page < total_pages %}
				<li class="page-item">
					<a class="page-link" href="?page={{ current_page + 1 }}&status={{ selected_status }}&priority={{ selected_priority }}&assigned_to={{ selected_assigned_to }}&search={{ search_query }}">Sau</a>
				</li>
				{% endif %}
			</ul>
		</nav>
		{% endif %}

		{% else %}
		<div class="text-center py-5">
			<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#6c757d" class="mb-3" viewBox="0 0 16 16">
				<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
			</svg>
			<h5 class="text-muted">Không có công việc nào</h5>
			<p class="text-muted">Chưa có công việc nào được tạo hoặc không tìm thấy công việc phù hợp với bộ lọc.</p>
			<a href="{{ url_for('pages.task_assignment_create_form') }}" class="btn btn-primary">
				Tạo công việc đầu tiên
			</a>
		</div>
		{% endif %}
	</div>
</div>

<!-- Form xóa ẩn -->
<form id="deleteForm" method="POST" style="display: none;">
	<input type="hidden" name="_method" value="DELETE">
</form>

<script>
function confirmDelete(taskId) {
	if (confirm('Bạn có chắc chắn muốn xóa công việc này?')) {
		const form = document.getElementById('deleteForm');
		form.action = '{{ url_for("pages.task_assignment_delete", task_id=0) }}'.replace('0', taskId);
		form.submit();
	}
}
</script>

{% endblock %}

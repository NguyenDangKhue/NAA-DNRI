{% extends 'base.html' %}
{% block title %}Chỉnh sửa mẫu chuẩn · LabManage{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="d-flex align-items-center">
		<a href="{{ url_for('pages.closing_standard') }}" class="btn btn-outline-secondary btn-sm me-3">
			<i class="bi bi-arrow-left"></i> Quay lại
		</a>
		<h1 class="h4 mb-0">Chỉnh sửa mẫu chuẩn</h1>
	</div>
</div>

<div class="row justify-content-center">
	<div class="col-12 col-lg-8">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-body p-4">
				<form method="post" action="{{ url_for('pages.closing_standard_update', standard_id=standard.id) }}">
					<div class="row g-3">
						<div class="col-md-6">
							<label class="form-label">Tên mẫu chuẩn</label>
							<select name="standard_name" id="standardNameSelect" class="form-control" required>
								<option value="">-- Chọn mẫu chuẩn --</option>
							</select>
							<small class="form-text text-muted">
								<a href="{{ url_for('pages.closing_standard_inventory') }}" target="_blank" class="text-decoration-none">
									<i class="bi bi-plus-circle"></i> Thêm mẫu chuẩn mới vào danh sách
								</a>
							</small>
						</div>
						<div class="col-md-6">
							<label class="form-label">Tên box</label>
							<input type="text" name="box_name" class="form-control" value="{{ standard.box_name }}" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">Khối lượng (g)</label>
							<input type="number" name="weight" id="weightInput" class="form-control" step="0.001" value="{{ standard.weight }}" required 
								   oninput="calculateCorrectedWeight()">
						</div>
						<div class="col-md-6">
							<label class="form-label">Độ ẩm (%)</label>
							<input type="number" name="moisture" id="moistureInput" class="form-control" step="0.01" value="{{ standard.moisture }}" 
								   oninput="calculateCorrectedWeight()">
						</div>
						<div class="col-md-6">
							<label class="form-label">Khối lượng hiệu chỉnh (g)</label>
							<input type="number" name="corrected_weight" id="correctedWeightInput" class="form-control" step="0.001" value="{{ standard.corrected_weight }}" readonly>
							<small class="form-text text-muted">Tự động tính: Khối lượng - (Khối lượng × Độ ẩm / 100)</small>
						</div>
						<div class="col-12">
							<label class="form-label">Ghi chú</label>
							<textarea name="note" class="form-control" rows="3">{{ standard.note }}</textarea>
						</div>
					</div>
					
					<div class="d-flex gap-2 mt-4">
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-check-circle"></i> Cập nhật mẫu chuẩn
						</button>
						<a href="{{ url_for('pages.closing_standard') }}" class="btn btn-outline-secondary">
							<i class="bi bi-x-circle"></i> Hủy
						</a>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
// Load standard names from inventory
function loadStandardNames() {
	fetch('/api/standard-inventory')
		.then(response => response.json())
		.then(inventories => {
			const select = document.getElementById('standardNameSelect');
			select.innerHTML = '<option value="">-- Chọn mẫu chuẩn --</option>';
			
			inventories.forEach(inventory => {
				const option = document.createElement('option');
				option.value = inventory.standard_name;
				option.textContent = inventory.standard_name;
				// Add standard type as data attribute
				option.setAttribute('data-standard-type', inventory.standard_type || '');
				
				// Select current standard name
				if (inventory.standard_name === '{{ standard.standard_name }}') {
					option.selected = true;
				}
				
				select.appendChild(option);
			});
		})
		.catch(error => {
			console.error('Error loading standard names:', error);
		});
}

// Auto-fill standard type when standard name is selected
document.getElementById('standardNameSelect').addEventListener('change', function() {
	const selectedOption = this.options[this.selectedIndex];
	const standardType = selectedOption.getAttribute('data-standard-type');
	
	// Auto-fill standard type if available
	if (standardType) {
		const standardTypeSelect = document.querySelector('select[name="standard_type"]');
		if (standardTypeSelect) {
			// Find matching option
			for (let option of standardTypeSelect.options) {
				if (option.value === standardType) {
					standardTypeSelect.value = standardType;
					break;
				}
			}
		}
	}
});

// Calculate corrected weight
function calculateCorrectedWeight() {
	const weight = parseFloat(document.getElementById('weightInput').value) || 0;
	const moisture = parseFloat(document.getElementById('moistureInput').value) || 0;
	const moistureWeight = weight * (moisture / 100);
	const correctedWeight = weight - moistureWeight;
	
	document.getElementById('correctedWeightInput').value = correctedWeight.toFixed(3);
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
	loadStandardNames();
	// Calculate initial corrected weight
	calculateCorrectedWeight();
});
</script>
{% endblock %}

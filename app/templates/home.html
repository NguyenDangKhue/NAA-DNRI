{% extends 'base.html' %}
{% block title %}Trang chủ · LabManage{% endblock %}
{% block content %}
<style>
	/* Navbar phối màu xanh navy và xanh teal hiện đại */
	.navbar.bg-dark {
		background: linear-gradient(90deg, #233554 0%, #2ec4b6 100%) !important;
	}
	.navbar .navbar-brand.lab-header {
		color: #f8fafc !important;
		text-shadow: 0 2px 8px rgba(44, 62, 80, 0.10);
	}
	.navbar .nav-link,
	.navbar .btn-outline-light,
	.navbar .nav-item.d-flex {
		color: #e0f2fe !important;
	}
	.navbar .nav-link.active, .navbar .nav-link:focus, .navbar .nav-link:hover {
		color: #2ec4b6 !important;
	}
	/* Nền tổng thể */
	body.bg-gradient {
		background: linear-gradient(120deg, #e0e7ef 0%, #f8fafc 100%);
	}
	
	/* Animation cho collapse */
	.collapse {
		transition: height 0.3s ease-in-out;
		overflow: hidden;
	}
	
	.collapse:not(.show) {
		height: 0;
	}
	
	.collapse.show {
		height: auto;
	}
	
	/* Style cho nút toggle của từng công việc */
	[id^="taskToggleIcon"] {
		font-weight: bold;
		font-size: 16px;
		transition: transform 0.2s ease;
	}
	
	.btn-outline-primary:hover [id^="taskToggleIcon"] {
		transform: scale(1.1);
	}
</style>

<script>
	// JavaScript để xử lý progress bar
	document.addEventListener('DOMContentLoaded', function() {
		const progressBars = document.querySelectorAll('.progress-bar[data-width]');
		progressBars.forEach(function(bar) {
			const width = bar.getAttribute('data-width');
			bar.style.width = width + '%';
		});
	});
	
	// JavaScript để toggle chi tiết giai đoạn cho từng công việc
	function toggleTaskDetails(taskId) {
		const container = document.getElementById('taskDetailsContainer' + taskId);
		const icon = document.getElementById('taskToggleIcon' + taskId);
		const text = document.getElementById('taskToggleText' + taskId);
		
		if (container.classList.contains('show')) {
			// Đóng
			container.classList.remove('show');
			icon.textContent = '+';
			text.textContent = 'Mở rộng';
		} else {
			// Mở
			container.classList.add('show');
			icon.textContent = '−';
			text.textContent = 'Thu gọn';
		}
	}
</script>

<div class="d-flex align-items-center justify-content-between mb-4">
	<div class="fw-semibold text-primary-emphasis" style="font-size: 1.05rem;">
		<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#2ec4b6" class="me-1 mb-1" viewBox="0 0 16 16">
			<path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
		</svg>
		Đăng nhập bởi: <strong class="text-dark">{{ username }}</strong>
	</div>
</div>

<!-- Các Module chính -->
<div class="row g-4 mt-4">
	<!-- Module Giao việc -->
	<div class="col-12">
		<div class="card shadow-sm border-0 rounded-4">
			<div class="card-header bg-success text-white">
				<h1 class="h4 mb-0">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
						<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
					</svg>
					Module Giao việc
				</h1>
			</div>
			<div class="card-body p-4">
				<!-- Thống kê nhanh -->
				<div class="row g-3 mb-4">
					<div class="col-md-3">
						<div class="card bg-primary text-white">
							<div class="card-body text-center">
								<h5 class="card-title">{{ task_stats.total }}</h5>
								<p class="card-text small">Tổng công việc</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card bg-warning text-white">
							<div class="card-body text-center">
								<h5 class="card-title">{{ task_stats.pending }}</h5>
								<p class="card-text small">Chờ xử lý</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card bg-info text-white">
							<div class="card-body text-center">
								<h5 class="card-title">{{ task_stats.in_progress }}</h5>
								<p class="card-text small">Đang xử lý</p>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="card bg-success text-white">
							<div class="card-body text-center">
								<h5 class="card-title">{{ task_stats.completed }}</h5>
								<p class="card-text small">Hoàn thành</p>
							</div>
						</div>
					</div>
				</div>

				<!-- Công việc gần đây -->
				<div class="row">
					<div class="col-12">
						<h5 class="mb-3">Công việc được giao gần đây</h5>
						{% if my_assigned_tasks %}
						{% for task in my_assigned_tasks[:5] %}
						<div class="card mb-3">
							<div class="card-header">
								<div class="d-flex align-items-center justify-content-between">
									<div>
										<h6 class="mb-0">
											<a href="{{ url_for('pages.task_assignment_detail', task_id=task.id) }}" class="text-decoration-none">
												Công việc #{{ task.id }}: {{ task.title }}
											</a>
										</h6>
										<div class="row mt-2">
											<div class="col-md-3">
												<small class="text-muted">Người giao: <strong>{{ task.assigned_by }}</strong></small>
											</div>
											<div class="col-md-2">
												<small class="text-muted">Độ ưu tiên: 
													{% if task.priority == 'high' %}
														<span class="badge bg-danger">Cao</span>
													{% elif task.priority == 'medium' %}
														<span class="badge bg-warning">Trung bình</span>
													{% else %}
														<span class="badge bg-secondary">Thấp</span>
													{% endif %}
												</small>
											</div>
											<div class="col-md-2">
												<small class="text-muted">Trạng thái: 
													{% if task.status == 'pending' %}
														<span class="badge bg-warning">Chờ xử lý</span>
													{% elif task.status == 'in_progress' %}
														<span class="badge bg-info">Đang xử lý</span>
													{% elif task.status == 'completed' %}
														<span class="badge bg-success">Hoàn thành</span>
													{% elif task.status == 'cancelled' %}
														<span class="badge bg-secondary">Đã hủy</span>
													{% endif %}
												</small>
											</div>
											<div class="col-md-2">
												<small class="text-muted">Giai đoạn: <span class="badge bg-primary">{{ task.stage_info.current_stage }}</span></small>
											</div>
											<div class="col-md-2">
												<small class="text-muted">Tiến độ: {{ task.stage_info.progress_percentage|round|int }}%</small>
											</div>
											<div class="col-md-1">
												<small class="text-muted">{{ task.created_at[:10] }}</small>
											</div>
										</div>
									</div>
									<div class="d-flex align-items-center gap-2">
										<button type="button" class="btn btn-outline-primary btn-sm" data-task-id="{{ task.id }}" onclick="toggleTaskDetails(this.dataset.taskId)">
											<span id="taskToggleIcon{{ task.id }}">+</span>
											<span id="taskToggleText{{ task.id }}">Chi tiết</span>
										</button>
										<div>
											{% if task.status == 'pending' %}
											<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
												<input type="hidden" name="status" value="in_progress">
												<button type="submit" class="btn btn-sm btn-outline-primary">Bắt đầu</button>
											</form>
											{% elif task.status == 'in_progress' %}
											<form method="POST" action="{{ url_for('pages.task_assignment_update_status', task_id=task.id) }}" class="d-inline">
												<input type="hidden" name="status" value="completed">
												<button type="submit" class="btn btn-sm btn-outline-success">Hoàn thành</button>
											</form>
											{% elif task.status == 'completed' %}
											{% if task.can_handover %}
											<a href="{{ url_for('pages.task_assignment_handover_form', task_id=task.id) }}" class="btn btn-sm btn-outline-info">
												<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
													<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
												</svg>
												Bàn giao
											</a>
											{% elif task.is_workflow_completed %}
											<span class="badge bg-success">Đã hoàn thành quy trình</span>
											{% else %}
											<span class="badge bg-info">Hoàn thành giai đoạn</span>
											{% endif %}
											{% endif %}
											
											<!-- Upload File -->
											{% if task.status == 'completed' or task.status == 'in_progress' %}
											<button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal{{ task.id }}">
												<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="me-1" viewBox="0 0 16 16">
													<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
													<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
												</svg>
												Upload
											</button>
											{% endif %}
										</div>
									</div>
								</div>
							</div>
							<div id="taskDetailsContainer{{ task.id }}" class="collapse">
								<div class="card-body">
									<div class="row">
										<div class="col-md-6">
											<h6 class="text-primary">Giai đoạn đã trải qua:</h6>
											{% if task.stage_info.completed_stages %}
											<ul class="list-unstyled">
												{% for stage in task.stage_info.completed_stages %}
												<li class="mb-2">
													<span class="badge bg-success me-2">✓</span>
													<strong>{{ stage.stage }}</strong>
													<br>
													<small class="text-muted">
														Người thực hiện: {{ stage.user }}
														{% if stage.handover_to %}
															{% if stage.user == stage.handover_to %}
																→ <span class="text-primary">Tiếp tục đảm nhận</span>
															{% else %}
																→ Bàn giao cho: {{ stage.handover_to }}
															{% endif %}
														{% endif %}
														<br>
														Thời gian: {{ stage.date[:16] }}
														{% if stage.note %}<br>Ghi chú: {{ stage.note }}{% endif %}
													</small>
												</li>
												{% endfor %}
											</ul>
											{% else %}
											<p class="text-muted">Chưa có giai đoạn nào được hoàn thành</p>
											{% endif %}
										</div>
										<div class="col-md-6">
											<h6 class="text-info">Giai đoạn hiện tại:</h6>
											<div class="alert alert-info">
												<strong>{{ task.stage_info.current_stage }}</strong>
												<br>
												<small>
													Người thực hiện: {{ task.assigned_to }}<br>
													Trạng thái: 
													{% if task.status == 'pending' %}
														<span class="badge bg-warning">Chờ xử lý</span>
													{% elif task.status == 'in_progress' %}
														<span class="badge bg-info">Đang xử lý</span>
													{% elif task.status == 'completed' %}
														<span class="badge bg-success">Hoàn thành</span>
													{% endif %}
												</small>
											</div>
											<div class="progress mb-2">
												<div class="progress-bar" role="progressbar" 
														 data-width="{{ task.stage_info.progress_percentage }}" 
														 aria-valuenow="{{ task.stage_info.progress_percentage }}" 
														 aria-valuemin="0" aria-valuemax="100">
													{{ task.stage_info.progress_percentage|round|int }}%
												</div>
											</div>
											<small class="text-muted">
												Tiến độ: {{ task.stage_info.current_stage_index + 1 }}/{{ task.stage_info.total_stages + 1 }} giai đoạn
											</small>
										</div>
									</div>
								</div>
							</div>
						</div>
						{% endfor %}
						
						<div class="text-center mt-3">
							<a href="{{ url_for('pages.task_assignment_my_tasks') }}" class="btn btn-success">
								Xem tất cả công việc của tôi
							</a>
							<a href="{{ url_for('pages.task_assignment_index') }}" class="btn btn-outline-success ms-2">
								Vào module Giao việc
							</a>
						</div>
						{% else %}
						<div class="text-center py-4">
							<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" class="mb-3" viewBox="0 0 16 16">
								<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
							</svg>
							<p class="text-muted">Chưa có công việc nào được giao cho bạn</p>
							<a href="{{ url_for('pages.task_assignment_index') }}" class="btn btn-success">
								Vào module Giao việc
							</a>
						</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Upload File Modals -->
{% for task in tasks_with_stages %}
{% if task.status == 'completed' or task.status == 'in_progress' %}
<div class="modal fade" id="uploadModal{{ task.id }}" tabindex="-1" aria-labelledby="uploadModalLabel{{ task.id }}" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="uploadModalLabel{{ task.id }}">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2" viewBox="0 0 16 16">
						<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
						<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
					</svg>
					Upload File - {{ task.title }}
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form method="POST" action="{{ url_for('pages.task_assignment_upload_file', task_id=task.id) }}" enctype="multipart/form-data">
				<div class="modal-body">
					<div class="mb-3">
						<label class="form-label">Chọn công đoạn <span class="text-danger">*</span></label>
						<select name="stage_name" class="form-select" required>
							<option value="">-- Chọn công đoạn --</option>
							<option value="Nhận mẫu">Nhận mẫu</option>
							<option value="Đóng mẫu">Đóng mẫu</option>
							<option value="Chiếu mẫu">Chiếu mẫu</option>
							<option value="Xử lý số liệu">Xử lý số liệu</option>
							<option value="Kiểm tra và duyệt kết quả">Kiểm tra và duyệt kết quả</option>
							<option value="Lưu kết quả">Lưu kết quả</option>
						</select>
					</div>
					<div class="mb-3">
						<label class="form-label">Chọn file <span class="text-danger">*</span></label>
						<input type="file" name="file" class="form-control" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.xls,.xlsx,.csv,.json,.zip,.rar" required>
						<div class="form-text">Hỗ trợ: Hình ảnh, PDF, Word, Excel, CSV, JSON, ZIP (tối đa 50MB)</div>
					</div>
					<div class="mb-3">
						<label class="form-label">Mô tả file</label>
						<input type="text" name="description" class="form-control" placeholder="Mô tả ngắn về file...">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
					<button type="submit" class="btn btn-primary">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16">
							<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
							<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
						</svg>
						Upload File
					</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endif %}
{% endfor %}

{% endblock %}
